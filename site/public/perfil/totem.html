<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/css/estilos-gerais.css">
    <link rel="stylesheet" href="../assets/css/sidebar.css">
    <link rel="stylesheet" href="../assets/css/totem.css">
    <title>Cadastro Totem</title>
</head>

<body>
    <main>
        <section class="main">
            <!-- SIDE BAR -->
            <div class="sidebar">
                <div class="perfilNome">
                    <img class="iconPerfilNome" src="../assets/img/usuario-de-perfil.png" alt="">
                    <span id="spanNome" class="nomePerfil"></span>
                </div>
                <div class="perfilFranquia">
                    <a class="ancora" href="franquia.html"><img class="iconPerfil" src="../assets/img/franquia.png"
                            alt=""></a>
                </div>
                <div class="perfilFuncionario">
                    <a class="ancora" href="func.html"><img class="iconPerfil"
                            src="../assets/img/carteira-de-identidade.png" alt=""></a>
                </div>
                <div class="perfilDefinicoes">
                    <a class="ancora" href="totem.html"><img class="iconPerfil totem" src="../assets/img/definicoes.png"
                            alt=""></a>
                </div>
                <div class="perfilGrafico">
                    <a class="ancora" href="dashGerente.html"><img class="iconPerfil"
                            src="../assets/img/grafico-preditivo.png" alt=""></a>
                </div>
                <button class="btnSair">Sair</button>
            </div>
            <!-- FIM DA SIDEBAR -->
            <div class="content-form">
                <div class="div-form">
                    <h1 class="title-form">Cadastre seu totem</h1>
                    <div class="form">
                        <div class="form-inputs">
                            <div class="parteForm">
                                <span class="tituloInp">Nome:</span>
                                <input id="apelidoTotem" class="inputs" type="text" placeholder="Número Serial">
                                <span class="tituloInp">Nome:</span>
                                <select name="" id="selectFranquia" class="comboBox" placeholder="Apelido">
                                    <option value="">Franquia</option>
                                </select>
                                <span class="tituloInp">Nome:</span>
                                <input id="discoTotem" class="inputs" type="text" placeholder="Disco">
                            </div>
                            <div class="parteForm">
                                <span class="tituloInp">Nome:</span>
                                <input id="processadorTotem" class="inputs" type="text" placeholder="Processador">
                                <span class="tituloInp">Nome:</span>
                                <input id="ramTotem" class="inputs" type="text" placeholder="Ram">
                            </div>
                        </div>
                        <div class="parametrizar">
                            <h1 class="titleParametrizar">Parametrizar Alertas</h1>
                            <p class="pDescricao">Digite a "%" de uso para gerarmos um alerta para cada componente.</p>
                            <div class="labelIpt">
                                <label for="processadorTotem" class="labelComponentes">Processador:</label>
                                <input id="processadorTotemA" class="inputs parametrizarIpts" type="number" min="1"
                                    max="100" placeholder="%">
                            </div>
                            <div class="labelIpt">
                                <label for="ramTotem" class="labelComponentes">Ram:</label>
                                <input id="ramTotemA" class="inputs parametrizarIpts" type="number" min="1" max="100"
                                    placeholder="%">
                            </div>
                            <div class="labelIpt">
                                <label for="discoTotem" class="labelComponentes">Disco:</label>
                                <input id="discoTotemA" class="inputs parametrizarIpts" type="number" min="1" max="100"
                                    placeholder="%">
                            </div>
                        </div>
                        <div class="div-btnConfirmar">
                            <button onclick="criarTotem()" class="btnConfirmar">
                                Confirmar
                            </button>
                        </div>
                    </div>
                    <div id="teste">
                        <div class="cardTotem">
                            <!-- <div class="iconTotem">
                                <img class="iconTotemSvg" src="../assets/img/totemSvg.svg" alt="imgTotem"> -->
                            </div>
                            <!-- <div class="atributs">
                                <div class="atributosTotem">
                                    <div class="individualAtributo primeiro">
                                        <p style="font-weight: bold;">Apelido: <span style="font-weight: 300;"
                                                id="apelido">HXR-480</span></p>
                                        <button class="btnAlterarApelido">Alterar</button>
                                    </div>
                                    <div class="individualAtributo">
                                        <p style="font-weight: bold">Ram: <span style="font-weight: 300;"
                                                id="ram">8GB</span></p>
                                    </div>
                                    <div class="individualAtributo">
                                        <p style="font-weight: bold">Disco: <span style="font-weight: 300;"
                                                id="disco">500GB</span></p>
                                    </div>
                                    <div class="individualAtributo">
                                        <p style="font-weight: bold">Processador: <span style="font-weight: 300;"
                                                id="processador">i7 10th</span></p>
                                    </div>
                                    <div class="individualAtributo">
                                        <p style="font-weight: bold">Marca: <span style="font-weight: 300;"
                                                id="marca">Asus</span></p>
                                    </div>
                                    <div class="individualAtributo">
                                        <p style="font-weight: bold;">Modelo: <span style="font-weight: 300;"
                                                id="modelo">????</span></p>
                                    </div>
                                    <div class="individualAtributo ultimo">
                                        <p style="font-weight: bold">Software: <span style="font-weight: 300;"
                                                id="software">Domingo's software</span></p>
                                    </div>
                                </div>
                                <div class="parametrosTotem">
                                    <h1 class="tituloParametrosTotem">Parâmetros para os Alertas</h1>
                                    <div class="individualAtributo parametrosAlterar">
                                        <p style="font-weight: bold;">Processador: <span style="font-weight: 300;"
                                                id="processador">90%</span></p>
                                        <button class="btnAlterarApelido">Alterar</button>
                                    </div>
                                    <div class="individualAtributo parametrosAlterar">
                                        <p style="font-weight: bold;">Ram: <span style="font-weight: 300;"
                                                id="processador">80%</span></p>
                                        <button class="btnAlterarApelido">Alterar</button>
                                    </div>
                                    <div class="individualAtributo parametrosAlterar">
                                        <p style="font-weight: bold;">Disco: <span style="font-weight: 300;"
                                                id="processador">75%</span></p>
                                        <button class="btnAlterarApelido">Alterar</button>
                                    </div>
                                    <button class="btnDeletarMaquina">
                                        Deletar
                                    </button>
                                </div>
                            </div> -->

                        </div>
                    </div>
                </div>
            </div>
            </div>


        </section>
    </main>
    <footer>

    </footer>



</body>

</html>

<script>
    var nome = sessionStorage.NOME_USUARIO;
    spanNome.innerHTML = nome;

    mostrarFranquia();

    function atualizarFeed() {
        // ATUALIZAR AQUI PARA DEPOIS O SESSION STORAGE

        idEmpresa = sessionStorage.ID_EMPRESA;

        //aguardar();
        fetch(`/totem/listarTotem/${idEmpresa}`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    var feed = document.getElementById("feed_container");
                    var mensagem = document.createElement("span");
                    mensagem.innerHTML = "Nenhum resultado encontrado."
                    feed.appendChild(mensagem);
                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    teste.innerHTML = "";
                    for (let i = 0; i < resposta.length; i++) {
                        var publicacao = resposta[i];

                        // criando e manipulando elementos do HTML via JavaScript

                        idDisco = `disco${publicacao.idTotem}${publicacao.fkEstabelecimento}`;
                        idProcess = `processador${publicacao.idTotem}${publicacao.fkEstabelecimento}`;
                        idRam = `ram${publicacao.idTotem}${publicacao.fkEstabelecimento}`;
                        idAlertaProcess = `alertaProcess${publicacao.idTotem}${publicacao.fkEstabelecimento}`;
                        idAlertaRam = `alertaRam${publicacao.idTotem}${publicacao.fkEstabelecimento}`;
                        idAlertaDisco = `alertaDisco${publicacao.idTotem}${publicacao.fkEstabelecimento}`;

                        teste.innerHTML += `
                        <div class="cardTotem">
                        <div class="iconTotem">
                            <img class="iconTotemSvg" src="../assets/img/totemSvg.svg" alt="imgTotem">
                        </div>
                        <div class="atributs">
                            <div class="atributosTotem">
                                <div class="individualAtributo primeiro">
                                    <p style="font-weight: bold;">Número Serial: <span style="font-weight: 300;" id="apelido">${publicacao.numeroSerial}</span></p>
                                </div>
                                <div class="individualAtributo">
                                    <p style="font-weight: bold">Franquia: <span style="font-weight: 300;" id="franquia">${publicacao.nome}</span></p>
                                </div>
                                <div class="individualAtributo">
                                    <p style="font-weight: bold">Disco: <span style="font-weight: 300;" id="${idDisco}">${publicacao.disco}</span></p>
                                </div>
                                <div class="individualAtributo">
                                    <p style="font-weight: bold">Processador: <span style="font-weight: 300;" id="${idProcess}">${publicacao.processador}</span></p>
                                </div>
                                <div class="individualAtributo">
                                    <p style="font-weight: bold">Ram: <span style="font-weight: 300;" id="${idRam}">${publicacao.ram}</span></p>
                                </div>
                            </div>
                            <div class="parametrosTotem">
                                <h1 class="tituloParametrosTotem">Parâmetros para os Alertas</h1>
                                <div class="individualAtributo parametrosAlterar">
                                    <p style="font-weight: bold;">Processador: <span style="font-weight: 300;" id="${idAlertaProcess}">${publicacao.alertaProcessador}%</span></p>
                                </div>
                                <div class="individualAtributo parametrosAlterar">
                                    <p style="font-weight: bold;">Ram: <span style="font-weight: 300;" id="${idAlertaRam}">${publicacao.alertaRam}%</span></p>
                                </div>
                                <div class="individualAtributo parametrosAlterar">
                                    <p style="font-weight: bold;">Disco: <span style="font-weight: 300;" id="${idAlertaDisco}">${publicacao.alertaDisco}%</span></p>
                                </div>
                                <div id="divBotoesTotem${publicacao.idTotem}${publicacao.fkEstabelecimento}" class="botoesTotem">
                                    <button id="btnConfirmar${publicacao.idTotem}${publicacao.fkEstabelecimento}" onclick="alterarInfoTotem(${publicacao.idTotem}, ${publicacao.fkEstabelecimento}, '${publicacao.disco}', '${publicacao.processador}', '${publicacao.ram}', ${publicacao.alertaProcessador}, ${publicacao.alertaRam}, ${publicacao.alertaDisco})" class="btnDeletarMaquina editar">
                                    Alterar
                                </button>
                                <button id="btnDeletar${publicacao.idTotem}${publicacao.fkEstabelecimento}" onclick="perguntarDeletar(${publicacao.idTotem}, ${publicacao.fkEstabelecimento}, '${publicacao.disco}', '${publicacao.processador}', '${publicacao.ram}', ${publicacao.alertaProcessador}, ${publicacao.alertaRam}, ${publicacao.alertaDisco})" class="btnDeletarMaquina">
                                    Deletar
                                </button>
                                </div>
                        `
                    }

                    // finalizarAguardar();
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
            // finalizarAguardar();
        });
    }

    // Função para editar

    function alterarInfoTotem(idTotem, fkEstabelecimento, disco, processador, ram, alertaProcess, alertaRam, alertaDisco) {

        mudarBotoes = document.getElementById(`divBotoesTotem${idTotem}${fkEstabelecimento}`);
        idDisco = document.getElementById(`disco${idTotem}${fkEstabelecimento}`);
        idProcess = document.getElementById(`processador${idTotem}${fkEstabelecimento}`);
        idRam = document.getElementById(`ram${idTotem}${fkEstabelecimento}`)
        idAlertaProcess = document.getElementById(`alertaProcess${idTotem}${fkEstabelecimento}`)
        idAlertaRam = document.getElementById(`alertaRam${idTotem}${fkEstabelecimento}`)
        idAlertaDisco = document.getElementById(`alertaDisco${idTotem}${fkEstabelecimento}`)

        idDisco.innerHTML = `<input id="iptDisco${idTotem}${fkEstabelecimento}" style="width: 120px;" class="inputs" placeholder="${disco}">`;
        idProcess.innerHTML = `<input id="iptProcess${idTotem}${fkEstabelecimento}"  style="width: 120px;" class="inputs" placeholder="${processador}">`;
        idRam.innerHTML = `<input id="iptRam${idTotem}${fkEstabelecimento}" style="width: 120px;" class="inputs" placeholder="${ram}">`;
        idAlertaProcess.innerHTML = `<input type="number" id="iptAlertProcess${idTotem}${fkEstabelecimento}" min="0" max="100" style="width: 120px;" class="inputs" placeholder="${alertaProcess}%">`;
        idAlertaRam.innerHTML = `<input type="number" id="iptAlertRam${idTotem}${fkEstabelecimento}" min="0" max="100" style="width: 120px;" class="inputs" placeholder="${alertaRam}%">`;
        idAlertaDisco.innerHTML = `<input type="number" id="iptAlertDisco${idTotem}${fkEstabelecimento}" min="0" max="100" style="width: 120px;" class="inputs" placeholder="${alertaDisco}%">`;

        mudarBotoes.innerHTML = `
        <button onclick="enviarInfoTotem(${idTotem}, ${fkEstabelecimento}, '${disco}', '${processador}', '${ram}', ${alertaProcess}, ${alertaRam}, ${alertaDisco})" class="btnDeletarMaquina confirmar">
                                    Confirmar
                                </button>
                                <button id="btnDeletar${idTotem}${fkEstabelecimento}" onclick="desfazerAlteracoes(${idTotem}, ${fkEstabelecimento}, '${disco}', '${processador}', '${ram}', ${alertaProcess}, ${alertaRam}, ${alertaDisco})" class="btnDeletarMaquina editar">
                                    Desfazer
                                </button>
        `;

    }


    // Função para enviar edição
    function enviarInfoTotem(idTotem, fkEstabelecimento, disco, processador, ram, alertaProcess, alertaRam, alertaDisco) {

        iptDisco = document.getElementById(`iptDisco${idTotem}${fkEstabelecimento}`);
        iptProcess = document.getElementById(`iptProcess${idTotem}${fkEstabelecimento}`);
        iptRam = document.getElementById(`iptRam${idTotem}${fkEstabelecimento}`)
        iptAlertProcess = document.getElementById(`iptAlertProcess${idTotem}${fkEstabelecimento}`)
        iptAlertRam = document.getElementById(`iptAlertRam${idTotem}${fkEstabelecimento}`)
        iptAlertDisco = document.getElementById(`iptAlertDisco${idTotem}${fkEstabelecimento}`)

        if (iptDisco.value != "") {
            disco = iptDisco.value
        }

        if(iptProcess.value != "") {
            processador = iptProcess.value
        }

        if(iptRam.value != "") {
            ram = iptRam.value
        }

        if(iptAlertProcess.value != "") {
            alertaProcess = iptAlertProcess.value
        }

        if(iptAlertRam.value != "") {
            alertaRam = iptAlertRam.value
        }

        if(iptAlertDisco.value != "") {
            alertaDisco = iptAlertDisco.value
        }

            fetch(`/totem/editarTotem/${idTotem}/${fkEstabelecimento}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    idTotem: idTotem,
                    fkEstabelecimento: fkEstabelecimento,
                    disco: disco,
                    processador: processador,
                    ram: ram,
                    alertaProcess: alertaProcess,
                    alertaRam: alertaRam,
                    alertaDisco: alertaDisco,
                })
            }).then(function (resposta) {

                if (resposta.ok) {
                    // window.alert("Post atualizado com sucesso pelo usuario de email: " + sessionStorage.getItem("EMAIL_USUARIO") + "!");
                    window.location = "/perfil/totem.html"
                } else if (resposta.status == 404) {
                    window.alert("Deu 404!");
                } else {
                    throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }


    function desfazerAlteracoes(idTotem, fkEstabelecimento, disco, processador, ram, alertaProcess, alertaRam, alertaDisco) {

        idDisco = document.getElementById(`disco${idTotem}${fkEstabelecimento}`);
        idProcess = document.getElementById(`processador${idTotem}${fkEstabelecimento}`);
        idRam = document.getElementById(`ram${idTotem}${fkEstabelecimento}`)
        idAlertaProcess = document.getElementById(`alertaProcess${idTotem}${fkEstabelecimento}`)
        idAlertaRam = document.getElementById(`alertaRam${idTotem}${fkEstabelecimento}`)
        idAlertaDisco = document.getElementById(`alertaDisco${idTotem}${fkEstabelecimento}`)
        mudarBotoes = document.getElementById(`divBotoesTotem${idTotem}${fkEstabelecimento}`);

        idDisco.innerHTML = `${disco}`;
        idProcess.innerHTML = `${processador}`;
        idRam.innerHTML = `${ram}`;
        idAlertaProcess.innerHTML = `${alertaProcess}%`;
        idAlertaRam.innerHTML = `${alertaRam}%`;
        idAlertaDisco.innerHTML = `${alertaDisco}%`;

        mudarBotoes.innerHTML = `
        <button id="btnConfirmar${idTotem}${fkEstabelecimento}" onclick="alterarInfoTotem(${idTotem}, ${fkEstabelecimento}, '${disco}', '${processador}', '${ram}', ${alertaProcess}, ${alertaRam}, ${alertaDisco})" class="btnDeletarMaquina editar">
                                    Alterar
                                </button>
                                <button id="btnDeletar${idTotem}${fkEstabelecimento}" onclick="perguntarDeletar(${idTotem}, ${fkEstabelecimento}, '${disco}', '${processador}', '${ram}', ${alertaProcess}, ${alertaRam}, ${alertaDisco})" class="btnDeletarMaquina">
                                    Deletar
                                </button>`
    }

    function perguntarDeletar(idTotem, fkEstabelecimento, disco, processador, ram, alertaProcess, alertaRam, alertaDisco) {
        mudarBotoes = document.getElementById(`divBotoesTotem${idTotem}${fkEstabelecimento}`);

        mudarBotoes.innerHTML = `
        <button id="btnConfirmar${idTotem}${fkEstabelecimento}" onclick="deletar(${idTotem}, ${fkEstabelecimento})" class="btnDeletarMaquina deletar">
                                    Confirmar
                                </button>
                                <button id="btnDeletar${idTotem}${fkEstabelecimento}" onclick="desfazerAlteracoes(${idTotem}, ${fkEstabelecimento}, '${disco}', '${processador}', '${ram}', ${alertaProcess}, ${alertaRam}, ${alertaDisco})" class="btnDeletarMaquina editar">
                                    Desfazer
                                </button>`
    }

    // Função para deletar

    function deletar(idTotem, fkEstabelecimento) {
        console.log("Criar função de apagar post escolhido - ID" + idTotem);
        fetch(`/totem/deletarTotem/${idTotem}/${fkEstabelecimento}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {

            if (resposta.ok) {
                // window.alert("Post deletado com sucesso pelo usuario de email: " + sessionStorage.getItem("EMAIL_USUARIO") + "!");

                // Colocar algum alerta aqui

                window.location = "/perfil/totem.html"
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function mostrarFranquia(fkEmpresa) {
        fkEmpresa = sessionStorage.ID_EMPRESA;
                //aguardar();
                fetch(`/franquias/listarFranquiaEmpresa/${fkEmpresa}`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    // var feed = document.getElementById("feed_container");
                    // var mensagem = document.createElement("span");
                    // mensagem.innerHTML = "Nenhum resultado encontrado."
                    // feed.appendChild(mensagem);
                    // throw "Nenhum resultado encontrado!!";
                }

                // COLOCAR DEPOIS O SESSION STORAGE DA EMPRESA ABAIXO
                // ------------------------------------------------------------------------------------------------------

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    teste.innerHTML = "";
                    for (let i = 0; i < resposta.length; i++) {
                        var publicacao = resposta[i];

                        // criando e manipulando elementos do HTML via JavaScript

                        selectFranquia.innerHTML += `
                        <option value="${publicacao.idEstabelecimento}">${publicacao.nome}</option>
                        `
                    }

                    // finalizarAguardar();
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
            // finalizarAguardar();
        });
    }

    function criarTotem() {
        // aguardar();

        //Recupere o valor da nova input pelo nome do id
        // Agora vá para o método fetch logo abaixo
        var fkEstabelecimentoVar = selectFranquia.value;
        var numeroSerialVar = apelidoTotem.value;
        var processadorVar = processadorTotem.value;
        var alertaProcessadorVar = processadorTotemA.value;
        var ramVar = ramTotem.value;
        var alertaRamVar = ramTotemA.value;
        var discoVar = discoTotem.value;
        var alertaDiscoVar = discoTotemA.value;

        // if (nomeVar == "" || emailVar == "" || senhaVar == "" || confirmacaoSenhaVar == "") {
        //     cardErro.style.display = "block"
        //     mensagem_erro.innerHTML = "(Mensagem de erro para todos os campos em branco)";

        //     finalizarAguardar();
        //     return false;
        // }
        // else {
        //     setInterval(sumirMensagem, 5000)
        // }

        // Enviando o valor da nova input
        fetch(`/totem/publicarTotem/${fkEstabelecimentoVar}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                fkEstabelecimentoServer: fkEstabelecimentoVar,
                numeroSerialServer: numeroSerialVar,
                processadorServer: processadorVar,
                alertaProcessadorServer: alertaProcessadorVar,
                ramServer: ramVar,
                alertaRamServer: alertaRamVar,
                discoServer: discoVar,
                alertaDiscoServer: alertaDiscoVar,
            })
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                // cardErro.style.display = "block";

                //APARECE UMA MENSAGEM DE CADASTRO REALIZADO

                // mensagem_erro.innerHTML = "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

                setTimeout(() => {
                    window.location = "/perfil/totem.html";
                }, "2000")

                // limparFormulario();
                // finalizarAguardar();
            } else {
                throw ("Houve um erro ao tentar realizar o cadastro!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
            // finalizarAguardar();
        });

        return false;
    }

    atualizarFeed()

</script>